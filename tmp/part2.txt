import { NextResponse } from 'next/server';
import { createClient } from '@supabase/supabase-js';
import { requireAdminSession } from '../../../../lib/auth/requireAdminSession';

const supabase = createClient(
  process.env.NEXT_PUBLIC_SUPABASE_URL,
  process.env.SUPABASE_SERVICE_ROLE_KEY
);

// Helper function to parse CSV
function parseCSV(csvText) {
  const lines = csvText.split('\n').filter(line => line.trim());
  if (lines.length < 2) {
    throw new Error('CSV must have at least a header row and one data row');
  }

  // Parse header
  const header = parseCSVLine(lines[0]);

  // Parse data rows
  const data = [];
  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i]);
    if (values.length === header.length) {
      const row = {};
      header.forEach((col, index) => {
        row[col] = values[index] || '';
      });
      data.push(row);
    }
  }

  return { header, data };
}

// Helper function to parse CSV line (handles quotes and commas)
function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;

  for (let i = 0; i < line.length; i++) {
    const char = line[i];

    if (char === '"') {
      if (inQuotes && line[i + 1] === '"') {
        current += '"';
        i++; // Skip next quote
      } else {
        inQuotes = !inQuotes;
      }
    } else if (char === ',' && !inQuotes) {
      result.push(current.trim());
      current = '';
    } else {
      current += char;
    }
  }

  result.push(current.trim());
  return result;
}

// Helper function to validate email
function isValidEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
}

// Helper function to validate phone number
function isValidPhone(phone) {
  // Basic phone validation - can be enhanced based on requirements
  const phoneRegex = /^[\d\s\-\+\(\)]+$/;
  return phoneRegex.test(phone) && phone.replace(/\D/g, '').length >= 10;
}

// Helper function to validate date
function isValidDate(dateString) {
  if (!dateString) return true; // Optional field
  const date = new Date(dateString);
  return !isNaN(date.getTime());
}

// Helper function to escape CSV values (reuse from download-csv)
function escapeCsvValue(value) {
  if (value === null || value === undefined) return '';

  const stringValue = String(value);

  if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
    return `"${stringValue.replace(/"/g, '""')}"`;
  }

  return stringValue;
}

export async function POST(request) {
  const session = await requireAdminSession();
  if (!session.authenticated) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  }

  try {
    const formData = await request.formData();
    const csvFile = formData.get('csvFile');

    if (!csvFile) {
      return NextResponse.json(
        { error: 'CSV file is required' },
        { status: 400 }
      );
    }

    // Read CSV file
    const csvText = await csvFile.text();

    // Parse CSV
    let parsedData;
    try {
      parsedData = parseCSV(csvText);
    } catch (parseError) {
      return NextResponse.json(
        { error: 'Failed to parse CSV file: ' + parseError.message },
        { status: 400 }
      );
    }

    const { header, data } = parsedData;

    if (data.length === 0) {
      return NextResponse.json(
        { error: 'CSV file contains no data rows' },
        { status: 400 }
      );
    }

    // Expected columns based on CSV template
    const requiredColumns = ['Full Name', 'Email', 'Phone Number'];
    const optionalColumns = [
      'Position Apply',
      'CV Name',
      'Father Name',
      'Mother Name',
      'Height',
      'Weight',
      'Marital Status',
      'Place of Birth',
      'Date of Birth',
      'Address',
      'Religion',
      'Citizenship',
      'Passport Number',
      'Passport Issued By',
      'Passport Issue Date',
      'Passport Expiry Date',
      'Mobile Number',
      'Email (CV)',
      'Emergency Contact Name',
      'Emergency Contact Number',
      'Emergency Contact Relation',
      'Emergency Contact Address'
    ];

    // Validate required columns exist
    const missingColumns = requiredColumns.filter(col => !header.includes(col));
    if (missingColumns.length > 0) {
      return NextResponse.json(
        {
          error: 'Missing required columns in CSV',
          missingColumns,
          requiredColumns
        },
        { status: 400 }
      );
    }

    // Get existing submissions for duplicate checking
    const { data: existingSubmissions, error: fetchError } = await supabase
      .from('submissions')
      .select('email, phoneNumber, fullName');

    if (fetchError) {
      console.error('Error fetching existing submissions:', fetchError);
      return NextResponse.json(
        { error: 'Failed to validate duplicates' },
        { status: 500 }
      );
    }

    const existingEmails = new Set(existingSubmissions.map(s => s.email.toLowerCase()));
    const existingPhones = new Set(existingSubmissions.map(s => s.phoneNumber));

    // Process and validate each row
    const processedCandidates = [];
    const validationErrors = [];
    const duplicates = [];

    data.forEach((row, index) => {
      const candidate = {
        rowIndex: index + 2, // +2 because: header is row 1, and data starts at row 2
        fullName: row['Full Name']?.trim() || '',
        email: row['Email']?.trim() || '',
        phoneNumber: row['Phone Number']?.trim() || '',
        positionApply: row['Position Apply']?.trim() || '',
        fatherName: row['Father Name']?.trim() || '',
        motherName: row['Mother Name']?.trim() || '',
        height: row['Height']?.trim() || '',
        weight: row['Weight']?.trim() || '',
        maritalStatus: row['Marital Status']?.trim() || '',
        placeOfBirth: row['Place of Birth']?.trim() || '',
        dateOfBirth: row['Date of Birth']?.trim() || '',
        address: row['Address']?.trim() || '',
        religion: row['Religion']?.trim() || '',
        citizenship: row['Citizenship']?.trim() || '',
        passportNumber: row['Passport Number']?.trim() || '',
        passportIssuedBy: row['Passport Issued By']?.trim() || '',
        passportIssueDate: row['Passport Issue Date']?.trim() || '',
        passportExpiryDate: row['Passport Expiry Date']?.trim() || '',
        mobileNumber: row['Mobile Number']?.trim() || '',
        emailCV: row['Email (CV)']?.trim() || '',
